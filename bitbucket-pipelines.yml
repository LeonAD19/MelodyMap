image: google/cloud-sdk:alpine

options:
  size: 2x

pipelines:
  branches:
    develop:
      - step:
          name: Deploy to Cloud Run (dev)
          oidc: true
          script:
            - set -euo pipefail
            - PROJECT_ID="melodymap-cs-3398"
            - REGION="us-central1"
            - SERVICE="melody-map"
            - echo "$BITBUCKET_STEP_OIDC_TOKEN" > /tmp/bb-oidc-token
            - "[ -s /tmp/bb-oidc-token ] || { echo 'OIDC token missing (enable oidc: true on this step)'; exit 1; }"
            - "awk -F. '{print NF}' /tmp/bb-oidc-token | grep -qx 3 || { echo 'Token not a JWT (three segments)'; exit 1; }"
            - test -f wif_config.json || { echo "wif_config.json missing at repo root"; exit 1; }
            - "sed -e 's#\\\"file\\\": *\\\".*\\\"#\\\"file\\\": \\\"/tmp/bb-oidc-token\\\"#g' wif_config.json > /tmp/wif.json"
            - "grep -q '\"file\": \"/tmp/bb-oidc-token\"' /tmp/wif.json || { echo 'Failed to patch credential_source.file'; exit 1; }"
            - gcloud auth login --cred-file=/tmp/wif.json --brief
            - gcloud config set project "$PROJECT_ID"
            - gcloud config set run/region "$REGION"
            - gcloud run deploy "$SERVICE" --source . --allow-unauthenticated --quiet
    main:
      - step:
          name: Deploy to Cloud Run (prod)
          oidc: true
          script:
            - set -euo pipefail
            - PROJECT_ID="melodymap-cs-3398"
            - REGION="us-central1"
            - SERVICE="melody-map"
            - echo "$BITBUCKET_STEP_OIDC_TOKEN" > /tmp/bb-oidc-token
            - "[ -s /tmp/bb-oidc-token ] || { echo 'OIDC token missing (enable oidc: true on this step)'; exit 1; }"
            - "awk -F. '{print NF}' /tmp/bb-oidc-token | grep -qx 3 || { echo 'Token not a JWT (three segments)'; exit 1; }"
            - test -f wif_config.json || { echo "wif_config.json missing at repo root"; exit 1; }
            - "sed -e 's|\"file\": *\".*\"|\"file\": \"/tmp/bb-oidc-token\"|g' wif_config.json > /tmp/wif.json"
            - "grep -q '\"file\": \"/tmp/bb-oidc-token\"' /tmp/wif.json || { echo 'Failed to patch credential_source.file'; exit 1; }"
            - gcloud auth login --cred-file=/tmp/wif.json --brief
            - gcloud config set project "$PROJECT_ID"
            - gcloud config set run/region "$REGION"
            - gcloud run deploy "$SERVICE" --source . --allow-unauthenticated --quiet
