image: google/cloud-sdk:alpine

options:
  size: 2x

definitions:
  scripts:
    - &deploy-script |
      echo "$BITBUCKET_STEP_OIDC_TOKEN" > ./bb-oidc-token
      sed "s|\"file\": *\"[^\"]*\"|\"file\": \"$(pwd)/bb-oidc-token\"|g" wif_config.json > ./wif.json
      gcloud auth login --cred-file=./wif.json
      gcloud run deploy "$SERVICE" --source . --project melodymap-cs-3398 --region us-central1 --allow-unauthenticated --quiet

pipelines:
  branches:
    develop:
      - step:
          name: Deploy to Cloud Run (dev)
          oidc: true
          script:
            - export SERVICE=melody-map-dev
            - *deploy-script
    main:
      - step:
          name: Deploy to Cloud Run (prod)
          oidc: true
          script:
            - export SERVICE=melody-map
            - *deploy-script
