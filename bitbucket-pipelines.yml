image: google/cloud-sdk:alpine

pipelines:
  branches:
    develop:
      - step:
          name: Deploy Flask App to Cloud Run
          script:
            - set -euo pipefail
            # Write the JSON key file safely
            - printf '%s' "$GCLOUD_SERVICE_KEY" | tr -d '\r' > "$HOME/gcloud-service-key.json"
            - '[ -s "$HOME/gcloud-service-key.json" ] || { echo "Key file is empty"; exit 1; }'
            - 'head -c 1 "$HOME/gcloud-service-key.json" | od -An -t x1 | grep -qi "7b" || { echo "Key does not start with {"; exit 1; }'
            # Authenticate & configure gcloud
            - gcloud auth activate-service-account --key-file "$HOME/gcloud-service-key.json"
            - gcloud config set project melodymap-cs-3398
            - gcloud config set run/region us-central1
            # Deploy to Cloud Run
            - gcloud run deploy melody-map --source . --allow-unauthenticated --clear-base-image

    main:
      - step:
          name: Deploy Flask App to Cloud Run (Production)
          script:
            - set -euo pipefail
            # Write the JSON key file safely
            - printf '%s' "$GCLOUD_SERVICE_KEY" | tr -d '\r' > "$HOME/gcloud-service-key.json"
            - '[ -s "$HOME/gcloud-service-key.json" ] || { echo "Key file is empty"; exit 1; }'
            - 'head -c 1 "$HOME/gcloud-service-key.json" | od -An -t x1 | grep -qi "7b" || { echo "Key does not start with {"; exit 1; }'
            # Authenticate & configure gcloud
            - gcloud auth activate-service-account --key-file "$HOME/gcloud-service-key.json"
            - gcloud config set project melodymap-cs-3398
            - gcloud config set run/region us-central1
            # Deploy to Cloud Run
